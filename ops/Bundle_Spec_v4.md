# Bundle Spec v4 — fl-bsa-whitepaper

> **Repo root**: This repo is **independent** from the main FL-BSA runtime repos.
> **Producer**: Evidence bundles are generated by `make gate-wp` in `fl-bsa`.

---

## 1. Overview

The reviewer-ready bundle `WhitePaper_Reviewer_Pack_v4.zip` contains:

| File | Description |
|------|-------------|
| `intake/metrics_uncertainty.json` | **v4 SoT**: deterministic fairness uncertainty surface (AIR + approval-rate gap with CIs and p-values; race pairwise vs reference) |
| `intake/metrics_long.csv` | Legacy/annex/back-compat metrics surface (may include bootstrap methods; not SoT for v4 PDF) |
| `intake/selection_rates.csv` | Per-group selection rates used by plots and cross-checks |
| `provenance/manifest.json` | Container digests, dataset hash, code commit, RNG seed, timestamps, and fairness orientation mapping/policy |
| `config/fairness_config.yaml` | Deterministic reference/protected mapping + visibility policy (mirrored into the manifest) |
| `intake/regulatory_matrix.csv` | No TBDs for in-scope controls |
| `certificates/*.json` | Evidence certificates (includes `synthetic_quality_certificate.json` for SQ threshold advisory text) |
| `config/sap.yaml` | Thresholds + reporting/SoT notes (methods/thresholds referenced by the whitepaper) |

**Optional but recommended:**
- `intake/calibration_bins.csv`
- `privacy/**` (if present in the run output and in scope)

---

## 2. Bundle Generation (Producer: fl-bsa)

```bash
cd /path/to/fl-bsa

# Full evidence generation
make gate-wp

# Outputs: artifacts/WhitePaper_Reviewer_Pack_v4.zip
```

The `gate-wp` target:
1. Starts FL-BSA services (API, Worker, Redis)
2. Generates a seeded synthetic dataset
3. Runs full bias analysis pipeline
4. Validates intake artifacts with strict schema checking
5. Repairs provenance with real hashes/digests
6. Packages everything into the bundle ZIP

---

## 3. Required Bundle Contents

### 3.1 intake/metrics_uncertainty.json (v4 SoT)

This file is the single source of truth for the v4 PDF’s fairness tables/plots.

**Required (high-level):**
- `schema_version`
- `primary_ratio_metric` (must be `air`)
- `fairness_uncertainty.gender` (binary AIR/SRG vs deterministic reference)
- `fairness_uncertainty.race` (multi-class, pairwise vs deterministic reference; includes `display_in_main_pdf` policy signal)

**Key contract points:**
- AIR CI: deterministic delta-method CI on log(AIR) (method: `wilson+delta`).
- Selection-rate CIs: Wilson.
- Race p-values: include Holm–Bonferroni adjusted values (`p_value_adjusted`, `p_value_adjustment: holm_bonferroni`).

### 3.2 intake/metrics_long.csv (legacy/annex/back-compat)

**Required columns:** `run_id,split,model_id,metric,group,value,lower_ci,upper_ci,n,method`

This file may include bootstrap metrics and legacy metric naming; it must not be treated as SoT for the v4 PDF.

### 3.3 provenance/manifest.json

**Required keys:**
- `run_id` — unique pipeline run identifier
- `dataset_hash` — `sha256:<hex>` of input dataset (prefix required)
- `commit_sha` — git commit of producer code
- `container_digest` — `repo@sha256:...` (no placeholders in CI)
- `rng_seed` — RNG seed for reproducibility
- `hardware` — execution environment info
- `start_ts`, `end_ts` — ISO timestamps

**v4 additions (required for deterministic orientation):**
- `fairness_reference_groups` (e.g., `{"gender":"male","race":"white"}`)
- `fairness_protected_groups` (e.g., `{"gender":["female"],"race":["black","asian","hispanic","other"]}`)
- `fairness_policy` (e.g., race visibility thresholds for the main PDF)

### 3.4 intake/regulatory_matrix.csv

**Required columns:** `framework, citation, requirement_text, control_assurance, evidence_artifact, owner, status, notes`

**Status values:** `in-place`, `validated`, `planned` (no `TBD` for in-scope items)

### 3.5 certificates/

At minimum, the bundle must include:
- `certificates/synthetic_quality_certificate.json` (SQ threshold values used by the PDF)
- `certificates/synthetic_validation_certificate.json`
- `certificates/regulatory_alignment_certificate.json`
- `certificates/model_certificate_amplification.json`
- `certificates/model_certificate_intrinsic.json`

### 3.6 config/sap.yaml

**Required thresholds:**
```yaml
thresholds:
  air_min: 0.80
  tpr_gap_max: 0.05
  fpr_gap_max: 0.05
  ece_max: 0.02
statistical:
  alpha: 0.05
inference:
  method: bca
  replicates: 2000
```

---

## 4. Consuming the Bundle (This Repo)

```bash
# Unzip the bundle from fl-bsa
unzip /path/to/WhitePaper_Reviewer_Pack_v4.zip -d /tmp/bundle

# Copy intake files to this repo
cp /tmp/bundle/intake/*.csv intake/
cp /tmp/bundle/intake/*.json intake/
cp /tmp/bundle/provenance/manifest.json intake/manifest.json
mkdir -p intake/certificates && cp /tmp/bundle/certificates/*.json intake/certificates/
cp /tmp/bundle/config/sap.yaml config/sap.yaml
cp /tmp/bundle/config/fairness_config.yaml config/fairness_config.yaml

# Generate LaTeX macros and build PDF
make pdf
```

---

## 5. Validation

The producer repo (`fl-bsa`) includes validation:

```bash
# In fl-bsa (root contains one or more pipeline directories)
python tools/ci/validate_wp_intake.py --root output
```

Validation checks:
- Required columns present in all CSVs
- CI bounds are sensible (lower ≤ value ≤ upper, all in [0,1])
- Provenance manifest has non-placeholder values
- Privacy evidence JSONs are valid

---

## 6. Style Guidelines

- **Paths:** `intake/` for metrics, `provenance/` for manifests
- **Names:** lowercase `snake_case` for files; metrics lowercase
- **Groups:** `attr:value` format everywhere
- **Dates/IDs:** ISO timestamps; stable `run_id` aligned between metrics and manifest
- **CIs:** Include `lower_ci`, `upper_ci`, and `n` for every metric row

---

## 7. Troubleshooting

| Problem | Cause | Fix |
|---------|-------|-----|
| Missing metrics | gate-wp not run | Run `make gate-wp` in fl-bsa |
| Placeholder digest | Local dev mode | Run in CI or set `CONTAINER_REF` env |
| Missing EO/ECE | Dataset lacks ground_truth | Set `WP_ENABLE_EO=1` |
| Schema errors | Wrong column names | Check CSV headers match spec |
| Regulatory TBDs | Incomplete matrix | Replace `TBD` with `planned` for in-scope items |

---

## 8. Independence from Runtime Repos

This repo does **not** depend on the FL-BSA runtime codebase.

**Linkage:** Fetch the bundle produced by `make gate-wp` in `fl-bsa` and copy relevant files to `intake/`.

All whitepaper artifacts, metrics, and evidence live **inside this repo** after import.
