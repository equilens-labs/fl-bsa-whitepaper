# Bundle Spec v4 — fl-bsa-whitepaper

> **Repo root**: This repo is **independent** from the main FL-BSA runtime repos.
> **Producer**: Evidence bundles are generated by `make gate-wp` in `fl-bsa`.

---

## 1. Overview

The reviewer-ready bundle `WhitePaper_Reviewer_Pack_v4.zip` contains:

| File | Description |
|------|-------------|
| `intake/metrics_long.csv` | Global metrics (AIR, tpr_gap, fpr_gap, ece) with 95% CIs; per-group selection_rate, tpr, fpr with CIs |
| `provenance/manifest.json` | Non-placeholder container digest, dataset hash, code commit, RNG seed, timestamps |
| `intake/regulatory_matrix.csv` | No TBDs for in-scope controls |
| `privacy/tests/*.json` | privacy_evidence_membership.json, privacy_evidence_attribute.json, dp_accounting.json |
| `config/sap.yaml` | Thresholds and bootstrap settings |

**Optional but recommended:**
- `intake/group_summary_*.csv`
- `intake/feature_missingness_*.csv`
- `intake/calibration_bins.csv`

---

## 2. Bundle Generation (Producer: fl-bsa)

```bash
cd /path/to/fl-bsa

# Full evidence generation
make gate-wp

# Outputs: artifacts/WhitePaper_Reviewer_Pack_v4.zip
```

The `gate-wp` target:
1. Starts FL-BSA services (API, Worker, Redis)
2. Generates a seeded synthetic dataset
3. Runs full bias analysis pipeline
4. Validates intake artifacts with strict schema checking
5. Repairs provenance with real hashes/digests
6. Packages everything into the bundle ZIP

---

## 3. Required Bundle Contents

### 3.1 intake/metrics_long.csv

**Required columns:** `run_id,split,model_id,metric,group,value,lower_ci,upper_ci,n,method`

**Required metrics:**
- Global: `air`, `tpr_gap`, `fpr_gap`, `ece` — each with 95% CIs and `n`
- Per-group: `selection_rate`, `tpr`, `fpr` for each `attr:value` with Wilson CIs

**Conventions:**
- `metric` names lowercase
- `group` formatted as `attr:value` (e.g., `gender:female`, `race:asian`)
- `split` ∈ {`train`, `validation`, `test`, `synthetic`}
- Stable `run_id` across runs

### 3.2 provenance/manifest.json

**Required keys:**
- `run_id` — unique pipeline run identifier
- `dataset_hash` — `sha256:...` of input dataset
- `commit_sha` — git commit of producer code
- `container_digest` — `repo@sha256:...` (no placeholders in CI)
- `rng_seed` — RNG seed for reproducibility
- `hardware` — execution environment info
- `start_ts`, `end_ts` — ISO timestamps

### 3.3 intake/regulatory_matrix.csv

**Required columns:** `framework, citation, requirement_text, control_assurance, evidence_artifact, owner, status, notes`

**Status values:** `in-place`, `validated`, `planned` (no `TBD` for in-scope items)

### 3.4 privacy/tests/

**Required files:**
- `privacy_evidence_membership.json` — keys: `mi_auc`, `method`, `notes`
- `privacy_evidence_attribute.json` — keys: `ai_auc`, `method`, `notes`
- `dp_accounting.json` — keys: `epsilon`, `delta`, `accountant`, `notes` (or `claimed: false`)

### 3.5 config/sap.yaml

**Required thresholds:**
```yaml
thresholds:
  air_min: 0.80
  tpr_gap_max: 0.05
  fpr_gap_max: 0.05
  ece_max: 0.02

bootstrap:
  B: 2000
  seed: 42
  method: percentile
```

---

## 4. Consuming the Bundle (This Repo)

```bash
# Unzip the bundle from fl-bsa
unzip /path/to/WhitePaper_Reviewer_Pack_v4.zip -d /tmp/bundle

# Copy intake files to this repo
cp /tmp/bundle/intake/*.csv intake/
cp /tmp/bundle/provenance/manifest.json intake/manifest.json

# Generate LaTeX macros and build PDF
make pdf
```

---

## 5. Validation

The producer repo (`fl-bsa`) includes validation:

```bash
# In fl-bsa
python tools/wp/validate_wp_intake.py --root output/<pipeline_id>/intake
```

Validation checks:
- Required columns present in all CSVs
- CI bounds are sensible (lower ≤ value ≤ upper, all in [0,1])
- Provenance manifest has non-placeholder values
- Privacy evidence JSONs are valid

---

## 6. Style Guidelines

- **Paths:** `intake/` for metrics, `provenance/` for manifests
- **Names:** lowercase `snake_case` for files; metrics lowercase
- **Groups:** `attr:value` format everywhere
- **Dates/IDs:** ISO timestamps; stable `run_id` aligned between metrics and manifest
- **CIs:** Include `lower_ci`, `upper_ci`, and `n` for every metric row

---

## 7. Troubleshooting

| Problem | Cause | Fix |
|---------|-------|-----|
| Missing metrics | gate-wp not run | Run `make gate-wp` in fl-bsa |
| Placeholder digest | Local dev mode | Run in CI or set `CONTAINER_REF` env |
| Missing EO/ECE | Dataset lacks ground_truth | Set `WP_ENABLE_EO=1` |
| Schema errors | Wrong column names | Check CSV headers match spec |
| Regulatory TBDs | Incomplete matrix | Replace `TBD` with `planned` for in-scope items |

---

## 8. Independence from Runtime Repos

This repo does **not** depend on the FL-BSA runtime codebase.

**Linkage:** Fetch the bundle produced by `make gate-wp` in `fl-bsa` and copy relevant files to `intake/`.

All whitepaper artifacts, metrics, and evidence live **inside this repo** after import.
