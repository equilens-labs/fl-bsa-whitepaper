name: pull-wp-intake

on:
  # Cross-repo automation strategies:
  # 1) repository_dispatch from fl-bsa (preferred) â€” see docs/ci_intake.md
  # 2) scheduled pull (daily)
  # 3) manual dispatch with inputs
  repository_dispatch:
    types: [wp-intake-ready]
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      producer_repo:
        description: "owner/repo of producer (fl-bsa)"
        required: false
        default: "equilens-labs/fl-bsa"
      workflow_file:
        description: "producer workflow file"
        required: false
        default: "wp-evidence-nightly.yml"
      artifact_name:
        description: "producer artifact name to download"
        required: false
        default: "wp-reviewer-pack-v4"
      branch:
        description: "producer branch (manual fetch)"
        required: false
        default: "main"

jobs:
  fetch-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps (for macro/plot generation)
        run: |
          python -m pip install --upgrade pip
          pip install pandas pyyaml matplotlib

      - name: Download reviewer bundle from producer
        uses: dawidd6/action-download-artifact@v6
        with:
          repo: ${{ github.event_name == 'workflow_dispatch' && inputs.producer_repo || github.event_name == 'repository_dispatch' && github.event.client_payload.producer_repo || 'equilens-labs/fl-bsa' }}
          workflow: ${{ github.event_name == 'workflow_dispatch' && inputs.workflow_file || github.event_name == 'repository_dispatch' && github.event.client_payload.workflow_file || 'wp-evidence-nightly.yml' }}
          workflow_conclusion: success
          branch: ${{ github.event_name == 'workflow_dispatch' && inputs.branch || github.event_name == 'repository_dispatch' && github.event.client_payload.branch || 'main' }}
          name: ${{ github.event_name == 'workflow_dispatch' && inputs.artifact_name || github.event_name == 'repository_dispatch' && github.event.client_payload.artifact_name || 'wp-reviewer-pack-v4' }}
          path: wp-bundle
          if_no_artifact_found: fail
          github_token: ${{ secrets.PRODUCER_TOKEN || github.token }}

      - name: Unpack reviewer bundle
        run: |
          set -euo pipefail
          bundle_path="$(find wp-bundle -maxdepth 5 -name 'WhitePaper_Reviewer_Pack_v4.zip' -print -quit || true)"
          if [ -z "$bundle_path" ]; then
            echo "Bundle zip not found under wp-bundle/" >&2
            find wp-bundle -maxdepth 5 -type f -print >&2 || true
            exit 1
          fi
          rm -rf bundle && mkdir -p bundle
          unzip -q "$bundle_path" -d bundle
          test -f bundle/provenance/manifest.json

      - name: Validate bundle schema versions
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          from pathlib import Path

          manifest_path = Path("bundle/provenance/manifest.json")
          m = json.loads(manifest_path.read_text(encoding="utf-8"))
          schema = str(m.get("schema_version") or "")

          if schema == "wp-intake.v1":
              required = [
                  "bundle/intake/metrics_uncertainty.json",
                  "bundle/intake/fairness_slices.json",
                  "bundle/intake/run_summary.json",
                  "bundle/certificates/synthetic_quality_certificate.json",
              ]
              missing = [p for p in required if not Path(p).exists()]
              if missing:
                  raise SystemExit(f"wp-intake.v1 bundle missing required files: {missing!r}")

              mu_path = Path("bundle/intake/metrics_uncertainty.json")
              mu = json.loads(mu_path.read_text(encoding="utf-8"))
              mu_schema = str(mu.get("schema_version") or "")
              if mu_schema != "fairness_uncertainty.v1":
                  raise SystemExit(
                      "Unexpected bundle metrics_uncertainty.schema_version="
                      f"{mu_schema!r}; expected 'fairness_uncertainty.v1'"
                  )

              print("Bundle schema/layout OK (wp-intake.v1)")
              raise SystemExit(0)

          raise SystemExit(
              f"Unexpected bundle provenance schema_version={schema!r}; "
              "expected 'wp-intake.v1' (update consumer workflow to support new schema versions)"
          )
          PY

      - name: Sync bundle contents into repo (intake/ + config/)
        run: |
          set -euo pipefail
          mkdir -p intake
          cp bundle/intake/*.csv intake/ || true
          cp bundle/intake/*.json intake/ || true
          cp bundle/provenance/manifest.json intake/manifest.json
          mkdir -p intake/certificates
          cp bundle/certificates/*.json intake/certificates/
          mkdir -p config
          cp bundle/config/sap.yaml config/sap.yaml
          if [ -f bundle/config/fairness_config.yaml ]; then
            cp bundle/config/fairness_config.yaml config/fairness_config.yaml
          fi

      - name: Generate TeX macros from metrics (tolerant)
        run: |
          make macros

      - name: Generate figures from intake (tolerant)
        run: |
          make plots

      - name: Compile LaTeX
        uses: xu-cheng/latex-action@v3
        with:
          root_file: main.tex
          latexmk_use_xelatex: false

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: whitepaper-pdf-from-intake
          path: main.pdf

      - name: Upload reviewer bundle used
        uses: actions/upload-artifact@v4
        with:
          name: reviewer-bundle-used
          path: wp-bundle/**/WhitePaper_Reviewer_Pack_v4.zip

      - name: Package arXiv source
        run: |
          bash scripts/arxiv_pack.sh

      - name: Upload arXiv source
        uses: actions/upload-artifact@v4
        with:
          name: arxiv-source-from-intake
          path: dist/whitepaper_arxiv_source.zip
